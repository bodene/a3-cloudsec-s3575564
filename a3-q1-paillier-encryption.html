<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Paillier Tool</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <style>
            /* Container */
            body {
                font-family: Arial, sans-serif;
                color: #333;
                margin: 20px;
            }
            .container {
                max-width: 900px;
                margin: 0 auto;
            }

            /* Headings */
            h1 {
                font-size: 24px;
                margin-bottom: 4px;
            }
            h2 {
                font-size: 16px;
                color: #666;
                margin-top: 0;
                margin-bottom: 20px;
            }

            /* Form fields */
            .field {
                margin-bottom: 16px;
            }
            .field label {
                display: block;
                font-weight: bold;
                margin-bottom: 4px;
            }
            .field input[type="text"],
            .field textarea {
                width: 100%;
                box-sizing: border-box;
                font-family: Consolas, monospace;
                font-size: 14px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            .field textarea {
                resize: vertical;
                min-height: 3em;
            }

            /* Read-only styling */
            .field input[readonly],
            .field textarea[readonly] {
                background-color: #f4f4f4;
            }

            /* Buttons */
            .buttons {
                margin-top: 10px;
                margin-bottom: 20px;
            }
            .buttons button {
                background-color: #007bff;
                color: #fff;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-right: 8px;
            }
            .buttons button:hover {
                background-color: #0056b3;
            }

            hr {
                margin: 30px 0;
                border: none;
                border-top: 1px solid #ddd;
            }
            .output {
                width: 100%;
                background: #f4f4f4;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                white-space: pre-wrap;
                word-break: break-all;
                box-sizing: border-box;
                margin-top: 4px;
            }
        </style>
    </head>
    <body>
    <div class="container">
        <h1>Cloud Security 2025</h1>
        <h2>Q1.5: Paillier Homomorphic Encryption</h2>

        <div class="field">
            <label for="plaintext">Plaintext Message:</label>
            <input id="plaintext" type="text" value="3575564January">
        </div>

        <div class="field">
            <label for ="m" >MD5(studentID||month) mod 10000 (hex):</label>
            <input id="m" type="text" readonly>
        </div>

        <div class="buttons">
            <button onclick="hashMessage()">Hash & Convert</button>
        </div>

        <div class="field">
            <label for ="r">Random (r) [hex]:</label>
            <input id="r" type="text" value="23">
        </div>

        <div class="field">
            <label for ="N">Public Key (N):</label>
            <div id="N" class="output"></div>
        </div>

        <div class="field">
            <label for ="g">Generator (g):</label>
            <div id="g" class="output"></div>
        </div>

        <div class="field">
            <label for ="phi">phi(N):</label>
            <div id="phi" class="output"></div>
        </div>

        <div class="field">
            <label for ="u">u (modinv of phi(N) mod N):</label>
            <div id="u" class="output"></div>
        </div>

        <div class="buttons">
            <button onclick="generateKeys()">Generate Keys</button>
            <button onclick="encrypt()">Encrypt</button>
        </div>

        <div class="field">
            <label for ="ciphertext">Ciphertext:</label>
            <textarea id="ciphertext" readonly rows="5"></textarea>
        </div>
    </div>

        <hr>
        <script>
            function egcd(a, b) {
                if (b === 0n) return { g: a, x: 1n, y: 0n };
                const { g, x: x1, y: y1 } = egcd(b, a % b);
                return { g, x: y1, y: x1 - (a / b) * y1 };
            }

            function modInverse(e, mod) {
                const { g, x } = egcd(e, mod);
                if (g !== 1n) throw new Error("modInverse: not coprime");
                return (x % mod + mod) % mod;
            }

            function modPow(base, exp, mod) {
                let result = 1n;
                base = base % mod;
                while (exp > 0n) {
                    if (exp % 2n === 1n) result = (result * base) % mod;
                    base = (base * base) % mod;
                    exp = exp >> 1n;
                }
                return result;
            }

            let global_p = BigInt("0xffe9eaabba466bc7f419676ed54787e90dd681a07dfdc97efa75fe767ba501761c2ce37119dae23b512d702bd2869fb9dd7fdeaa0889d30ecf597656bc69661b");
            let global_q = BigInt("0x89ec0b92805754e440a60a3fc06bd66de2d70c69fd00adc54e5919f84a37a5a326feec974fe01d0cb5b4acd27efa2e15527c07ea53324768932c71acbad4190d");

            function generateKeys() {
                const N = global_p * global_q;
                const g = N + 1n;
                const phi = (global_p - 1n) * (global_q - 1n);
                const u = modInverse(phi, N);

                document.getElementById('N').textContent = N.toString(16);
                document.getElementById("g").textContent = g.toString(16);
                document.getElementById("phi").textContent = phi.toString(16);
                document.getElementById("u").textContent = u.toString(16);
            }

            function hashMessage() {
                const message = document.getElementById("plaintext").value;
                const hash = CryptoJS.MD5(message).toString();
                const truncated = hash.slice(-4);
                const m = BigInt("0x" + truncated);
                document.getElementById("m").value = m.toString(16);
            }

            function encrypt() {
                const m = BigInt("0x" + document.getElementById("m").value);
                const r = BigInt("0x" + document.getElementById("r").value);
                const N = BigInt("0x" + document.getElementById("N").textContent);
                const g = BigInt("0x" + document.getElementById("g").textContent);
                const N2 = N * N;

                const gm = modPow(g, m, N2);
                const rN = modPow(r, N, N2);
                const c = (gm * rN) % N2;

                document.getElementById("ciphertext").value = c.toString(16);
            }
        </script>
    </body>
</html>